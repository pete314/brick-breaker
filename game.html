<!DOCTYPE html>
<html>
    <head>
        <title>Brick breaker game</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./style/main.css" />
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    </head>
    <body class="bodygame">
        <canvas id="gamecanvas"></canvas>
        <div id="dialog-confirm" title="You died :( ">
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
        <script type="text/javascript">
            //Canvas and Context setup
            var canvas = document.getElementById("gamecanvas");
            var ctx = canvas.getContext("2d");
            ctx.canvas.width  = window.innerWidth-30;
            ctx.canvas.height = window.innerHeight-50;
            
            //Ball variables
            var ballRadius = 10;
            var x = canvas.width/2;
            var y = canvas.height-90;
            var dx = 2;
            var dy = -2;
            var offsetBottom = 30;
            
            //Paddle & moovment variable variables
            var rightPressed = false;
            var leftPressed = false;
            var PADDLE_VARS = {height: 10, width: 65, x: (canvas.width-65)/2};
            
            //Pause game
            var isPaused = false;
            
            //Brick variables
            var currentColumnNums = window.innerWidth-30 < 640 ? 9 : window.innerWidth-30 < 1024 ? 15 : 20;
            var BRICK_CONSTANTS = {rowCount: currentColumnNums, columnCount: 3, width: 65, height: 20, padding: 10, offsetTop: 30, offsetLeft: 30};
            
            //Score variables
            var score = 0;
            var lives = 3;
            var level = 1;
            var bricks = [];
            
            //Canvas window height and width
            // resize the canvas to fill browser window dynamically
            window.addEventListener('resize',
                        (function(){
                            ctx.canvas.width = window.innerWidth-50;
                            ctx.canvas.height = window.innerHeight-50;
                            currentColumnNums = window.innerWidth-30 < 640 ? 9 : window.innerWidth-30 < 1024 ? 15 : 20;
                        }), false);
            
            //Game functions from here
            
            //generate all the bricks
            function initBricks(){   
                for(c=0; c<BRICK_CONSTANTS.columnCount; c++) {
                    bricks[c] = [];
                    for(r=0; r<BRICK_CONSTANTS.rowCount; r++) {
                        bricks[c][r] = { x: 0, y: 0, status: 1 };
                    }
                }
            }
            initBricks();
            
            function drawBrick(xPos, yPos, color){
                ctx.beginPath();
                ctx.rect(xPos, yPos, BRICK_CONSTANTS.width, BRICK_CONSTANTS.height);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.closePath();
            }
            
            function drawBricks() {
                var colors = ["#FF0066", "#66FF33", "#FF6600", "#00CC99", "#3333FF"];
                for(c=0; c<BRICK_CONSTANTS.columnCount; c++) {
                    for(r=0; r<BRICK_CONSTANTS.rowCount; r++) {
                        if(bricks[c][r].status == 1) {
                            var brickX = (r*(BRICK_CONSTANTS.width+BRICK_CONSTANTS.padding))+BRICK_CONSTANTS.offsetLeft;
                            var brickY = (c*(BRICK_CONSTANTS.height+BRICK_CONSTANTS.padding))+BRICK_CONSTANTS.offsetTop;
                            bricks[c][r].x = brickX;
                            bricks[c][r].y = brickY;
                            
                            drawBrick(brickX, brickY, colors[c%5]);
                        }
                    }
                }
            }
            
            //The ball
            function drawBall() {
                ctx.beginPath();
                ctx.arc(x, y, ballRadius, 0, Math.PI*2);
                ctx.fillStyle = "#1A1AFF";
                ctx.fill();
                ctx.closePath();
            }
            
            function goTonextLevel(){
                level += 1;
                lives +=3;
                BRICK_CONSTANTS.columnCount = level * 2 > 12 ? 12 : level === 2 ? level * 2.5 : level * 2;
                initBricks();
            }
            
            //Brick-ball collisison detection
            function brickCollisionDetection() {
                for(c=0; c<BRICK_CONSTANTS.columnCount; c++) {
                    for(r=0; r<BRICK_CONSTANTS.rowCount; r++) {
                        var b = bricks[c][r];
                        if(b.status == 1) {
                            if(x > b.x && x < b.x+BRICK_CONSTANTS.width && y > b.y && y < b.y+BRICK_CONSTANTS.height) {
                                dy = -dy;
                                b.status = 0;
                                score++;
                                if(score == BRICK_CONSTANTS.rowCount*BRICK_CONSTANTS.columnCount) {
                                    goTonextLevel();
                                    //document.location.reload();
                                }
                            }
                        }
                    }
                }
            }
            
            //Ball collision detection
            function ballCollisionDetection(){
                if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) {
                    dx = -dx;
                }
                if(y + dy < ballRadius) {
                    dy = -dy;
                }else if(y + dy > canvas.height-ballRadius - offsetBottom -PADDLE_VARS.height ) {
                    if(x > PADDLE_VARS.x && x < PADDLE_VARS.x + PADDLE_VARS.width) {
                        dy = -dy;
                    }
                    else {
                        lives--;
                        if(!lives) {
                            confirmGamePlay();    
                        }
                        else {
                            x = canvas.width/2;
                            y = canvas.height-90;
                            dx = 3;
                            dy = -3;
                            PADDLE_VARS.x = (canvas.width-PADDLE_VARS.width)/2;
                        }
                    }
                }
                if(rightPressed && PADDLE_VARS.x < canvas.width-PADDLE_VARS.width) {
                    PADDLE_VARS.x += 7;
                }
                else if(leftPressed && PADDLE_VARS.x > 0) {
                    PADDLE_VARS.x -= 7;
                }
                x += dx;
                y += dy;
            };
            
            function confirmGamePlay(){
                isPaused = true;
                $(function() {
                    $( "#dialog-confirm" ).dialog({
                      resizable: false,
                      height:140,
                      width: 350,
                      modal: false,
                      buttons: {
                        "Play again": function() {
                          $( this ).dialog( "close" );
                          document.location.reload();
                        },
                        "Back to index": function() {
                          $( this ).dialog( "close" );
                          window.open("index.html","_self");
                        }
                      }
                    });
                });
            }
    
            //Controll key functions
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);
            document.addEventListener("mousemove", mouseMoveHandler, false);
            
            function keyDownHandler(e) {
                if(e.keyCode == 39) {
                    rightPressed = true;
                }
                else if(e.keyCode == 37) {
                    leftPressed = true;
                }else if(e.keyCode == 80){
                    if(isPaused === false){
                        isPaused = true;
                    }else{
                        isPaused = false;
                    }
                }
            }
            function keyUpHandler(e) {
                if(e.keyCode == 39) {
                    rightPressed = false;
                }
                else if(e.keyCode == 37) {
                    leftPressed = false;
                }
            }
            function mouseMoveHandler(e) {
                var relativeX = e.clientX - canvas.offsetLeft;
                if(relativeX > 0 && relativeX < canvas.width) {
                    PADDLE_VARS.x = relativeX - PADDLE_VARS.width/2;
                }
            }
            
            //Draw functions from here
            function drawPaddle() {
                ctx.beginPath();
                ctx.rect(PADDLE_VARS.x, canvas.height-(PADDLE_VARS.height + offsetBottom), PADDLE_VARS.width, PADDLE_VARS.height);
                ctx.fillStyle = "#FF1A1A";
                ctx.fill();
                ctx.closePath();
            }

            function drawScore() {
                ctx.font = "16px Comic Sans MS";
                ctx.fillStyle = "#00E600";
                ctx.fillText("Score: "+score, canvas.width-250, canvas.height - 10);
            }
            
            function drawLives() {
                ctx.font = "16px Comic Sans MS";
                ctx.fillStyle = "#00E600";
                ctx.fillText("Lives: "+lives, canvas.width-165, canvas.height - 10);
            }
            
            function drawLevel() {
                ctx.font = "16px Comic Sans MS";
                ctx.fillStyle = "#00E600";
                ctx.fillText("Level: "+level, canvas.width-350, canvas.height - 10);
            }

            function drawPausedText(){
                ctx.font = "25px Comic Sans MS";
                ctx.fillStyle = "#00CCCC";

                ctx.fillText("GAME PAUSED", canvas.width/2, canvas.height/2);
                ctx.fillText("------------------", canvas.width/2, canvas.height/2 + 15);
                ctx.fillText("      Lives: " + lives, canvas.width/2, canvas.height/2 + 40);
                ctx.fillText("      Score: " + score, canvas.width/2, canvas.height/2 + 75);
                ctx.fillText("      Level: " + level, canvas.width/2, canvas.height/2 + 100);
            }
    
            //Main draw function with animation frame
            function draw() {
                //check if game is paused
                if(isPaused === true){
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawPausedText();
                }else{
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawBricks();
                    drawBall();
                    drawPaddle();
                    drawScore();
                    drawLives();
                    drawLevel();
                    brickCollisionDetection();
                    ballCollisionDetection();
                }
                requestAnimationFrame(draw);
            }
            draw();
            
        </script>
    </body>
</html>
